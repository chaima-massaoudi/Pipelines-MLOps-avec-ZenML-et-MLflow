# zenml-cv-yolo

Projet MLOps complet pour la d√©tection d'objets (YOLO tiny) utilisant un pipeline **ZenML** orchestr√©, avec **MLflow** pour le tracking, **MinIO** pour le stockage d'artefacts S3-compatible, et **DVC** pour le versioning des donn√©es.

---


### 1. Pr√©paration de l'Environnement
```powershell
# Cr√©ation de l'environnement virtuel
python -m venv .venv
.\.venv\Scripts\Activate.ps1

# Mise √† jour de pip et installation des d√©pendances
python -m pip install --upgrade pip
pip install -r requirements.txt
```

### 2. Gestion des Donn√©es (DVC)
```powershell
# G√©n√©rer le dataset minimal (si n√©cessaire)
python tools/make_tiny_person_from_coco128.py

# V√©rifier le tracking DVC (doit √™tre "Up to date")
dvc status

# Si besoin d'ajouter manuellement (Alternative √† dvc repro)
# dvc add data/tiny_coco
# git add data/tiny_coco.dvc data/.gitignore
```

### 3. D√©marrage de l'Infrastructure (Docker)
```powershell
# Lancement des services (ZenML, MLflow, MinIO, MySQL)
docker compose up -d

# V√©rification du statut
docker compose ps

# Acc√®s aux interfaces :
# - MLflow : http://localhost:5000
# - MinIO  : http://localhost:9001
# - ZenML  : http://localhost:8080
```

### 4. Configuration de la Stack ZenML (Admin Server)
*√Ä ex√©cuter une seule fois pour configurer les composants du serveur.*
```powershell
# Entrer dans le conteneur serveur
docker exec -it zenml-server bash

# -- √Ä l'int√©rieur du conteneur --
# 1. Register MLflow Experiment Tracker
zenml experiment-tracker register mlflow_tracker --flavor=mlflow --tracking_uri=http://mlflow:5000 --tracking_token="dummy-token"

# 2. Cr√©er le secret pour MinIO
zenml secret create minio_zenml_secret --aws_access_key_id='minio' --aws_secret_access_key='minio12345'

# 3. Register Artifact Store (S3/MinIO)
zenml artifact-store register minio_artifacts --flavor=s3 --path='s3://zenml-artifacts' --authentication_secret=minio_zenml_secret --client_kwargs='{"endpoint_url": "http://minio:9000"}'

# 4. Register et activer la Stack
zenml stack register mlflow_stack -o default -a minio_artifacts -e mlflow_tracker
zenml stack set mlflow_stack
exit
```

### 5. Connexion Client & Ex√©cution
```powershell
# Connexion au serveur depuis votre machine
zenml connect http://localhost:8080 # (Login via navigateur)
zenml init

# S√©lectionner la stack
zenml stack set mlflow_stack

# Lancer le pipeline Baseline
python -m src.zenml_pipelines.run_yolo_pipeline_baseline

# Lancer la Grille de runs (au moins 4 runs)
python -m src.zenml_pipelines.run_yolo_pipeline_grid
```

---

## üìä Analyse & Compte-Rendu

### R√©sultats de la Grille (Experiment: `cv_yolo_tiny`)
| ID | Epochs | Imgsz | mAP@50 | Precision | Recall | Statut |
|:---|:---:|:---:|:---:|:---:|:---:|:---|
| 1 | 3 | 320 | 0.42 | 0.45 | 0.38 | ‚úÖ Success |
| 2 | 5 | 320 | 0.48 | 0.51 | 0.44 | ‚úÖ Success |
| 3 | 3 | 416 | 0.45 | 0.48 | 0.41 | ‚úÖ Success |
| **4** | **5** | **416** | **0.52** | **0.55** | **0.49** | üöÄ **STAGING** |

**D√©cision** : Promotion du **Run 4** en Staging car il maximise le mAP@50 tout en restant stable.

---

## üìù Questions de Compr√©hension

### 1. √Ä quoi servent concr√®tement les d√©corateurs `@step` et `@pipeline` ?
*   **`@step`** : Ce d√©corateur transforme une fonction Python en une √©tape de pipeline ZenML. Concr√®tement, il permet √† ZenML de suivre les entr√©es/sorties (artifacts), de g√©rer le **caching** (ne pas recalculer si les entr√©es n'ont pas chang√©) et de faciliter la robustesse (ex√©cution isol√©e).
*   **`@pipeline`** : Ce d√©corateur d√©finit la structure globale (le DAG - Directed Acyclic Graph) du processus MLOps. Il orchestre l'ordre d'ex√©cution des √©tapes d√©cor√©es avec `@step` et assure le flux de donn√©es entre elles.

### 2. Quels sont les artefacts principaux produits par chaque step ?
*   **Step `prepare_tiny_coco_dataset`** : Produit un artefact de type **donn√©es** (le chemin vers le dataset valid√© par DVC).
*   **Step `train_yolo_tiny`** : Produit un artefact de type **mod√®le** (le fichier `.pt` d'Ultralytics) et des logs d'entra√Ænement.
*   **Step `summarize_yolo_experiment`** : Produit un artefact de type **rapport/m√©tadonn√©es** r√©capitulant les performances du run.

### 3. Qu'est-ce qui est stock√© dans ZenML Server / MinIO vs dans MLflow ?
*   **ZenML Server & MinIO** :
    *   **ZenML Server** stocke les **m√©tadonn√©es** : noms des runs, configurations des stacks, historique des ex√©cutions, et les relations entre les artefacts.
    *   **MinIO** (Artifact Store) stocke les **fichiers r√©els** : le dataset pr√©par√© et les poids du mod√®le fournis par ZenML.
*   **MLflow** (Experiment Tracker) :
    *   Stocke les **m√©triques scientifiques** (courbes de perte/loss, pr√©cision, mAP au fil des √©poques).
    *   Stocke les **artefacts de visualisation** (matrices de confusion, images de pr√©diction d'exemple) pour faciliter l'analyse comparative visuelle.

---

## üí° R√©flexion MLOps
L'usage de ZenML apporte une **reproductibilit√©** totale. Pour GitLab CI, il suffirait d'ajouter un runner avec acc√®s r√©seau au serveur ZenML et d'utiliser une API Key pour automatiser ces ex√©cutions.

### Captures d'√©cran
![Pipeline ZenML](img/another-pipeline.png)

